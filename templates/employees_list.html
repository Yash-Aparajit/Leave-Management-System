{% extends 'base.html' %}
{% block title %}Employees{% endblock %}

{% block content %}
<a class="btn btn-outline-secondary back-btn" href="{{ url_for('index') }}"><i class="bi bi-arrow-left"></i> Back</a>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h4>Employees</h4>
    <div class="small text-muted">Current employees ({{ total or employees|length }})</div>
  </div>
  <div class="d-flex align-items-center gap-2">
    <form class="d-flex" method="get" action="{{ url_for('employees_list') }}">
      <input name="q" class="form-control form-control-sm" placeholder="Search by ID or name" value="{{ q }}">
      <button class="btn btn-sm btn-outline-secondary ms-2" type="submit"><i class="bi bi-search"></i></button>
    </form>

    <div class="dropdown ms-2">
      <button class="btn btn-sm btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">Export employees</button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="{{ url_for('export_employees') }}">Download CSV</a></li>
        <li><a class="dropdown-item" href="{{ url_for('export_employees', format='xlsx') }}">Download Excel (.xlsx)</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="card p-3">
  {% if employees %}
    <div class="table-responsive">
      <table class="table table-sm">
        <thead class="table-light">
          <tr><th>EMP ID</th><th>Name</th><th>Department</th><th>Designation</th><th>Balance</th><th>Action</th></tr>
        </thead>
        <tbody>
          {% for e in employees %}
            <tr>
              <td>{{ e.employee_id }}</td>
              <td>{{ e.first_name }} {% if e.middle_name %}{{ e.middle_name }}{% endif %} {{ e.last_name }}</td>
              <td>{{ e.department or '-' }}</td>
              <td>{{ e.designation or '-' }}</td>
              <td>{{ balances.get(e.id, 0) }}</td>
              <td>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('employee_detail', emp_id=e.id) }}">Open</a>
                {% if session.get('role') in ('developer','admin_master') or has_permission('can_edit_employee') %}
                  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('edit_employee', emp_id=e.id) }}">Edit</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if total and total > per_page %}
      <nav aria-label="pagination">
        <!-- basic pager -->
        <ul class="pagination pagination-sm">
          {% if page > 1 %}
            <li class="page-item"><a class="page-link" href="{{ url_for('employees_list', page=page-1, q=q, status=status) }}">Prev</a></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Page {{ page }}</span></li>
          {% if (page * per_page) < total %}
            <li class="page-item"><a class="page-link" href="{{ url_for('employees_list', page=page+1, q=q, status=status) }}">Next</a></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="text-muted">No employees found.</div>
  {% endif %}
</div>
{% endblock %}
